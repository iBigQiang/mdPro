# 升级日志文档

日期：2025-12-05

本文件记录每次功能升级的关键改动、代码位置与配套说明，便于后续快速定位与调整参数。

## PC 预览宽度优化与快捷切换按钮

- 目标：为中间预览区域提供接近公众号桌面浏览器的中栏宽度，并新增“手机/电脑”一键切换按钮。

- 关键改动：
  - packages/shared/src/configs/style.ts:115
    - 电脑端宽度由 `w-full` 调整为 `w-full max-w-[740px]`。
    - 说明：`max-w-[740px]` 限制最大宽度为 740px，同时在小屏下保持自适应填满。
    - 调整方式：如需改为 720/760/780px，只需把该处的数值改为 `max-w-[720px]`/`max-w-[760px]`/`max-w-[780px]`。

  - apps/web/src/components/editor/editor-header/index.vue
    - 引入图标与配置：顶部导入 `Monitor`、`Smartphone` 以及 `widthOptions`。
      - 位置：文件开头的 import（约第 2 行处）。
    - 状态与选项：通过 `storeToRefs(themeStore)` 读取 `previewWidth`，并定义 `mobileWidth = widthOptions[0].value`、`desktopWidth = widthOptions[1].value`。
      - 位置：脚本顶部状态区域（约第 30–40 行处）。
    - 切换函数：新增 `togglePreviewMode()`，在手机与电脑宽度之间切换，并调用 `editorRefresh()` 立即生效。
      - 位置：函数定义（约第 240 行附近）。
    - 顶部右侧按钮：在“复制”按钮左侧新增“手机/电脑”按钮，图标随当前模式变化。
      - 位置：template 右侧操作区（约第 283 行处）。

  - apps/web/src/views/CodemirrorEditor.vue:735
    - 预览容器类名绑定：非移动端直接应用 `themeStore.previewWidth`，配合 `mx-auto` 居中显示。
    - 说明：移动端仍强制 `w-full`，桌面端将受 `max-w-[740px]` 限制并居中显示。

  - apps/web/src/components/editor/editor-header/ViewDropdown.vue:70–83, 165–178
    - 视图菜单的“预览模式”子项：与 `widthOptions` 同源，和顶部按钮共用同一状态 `previewWidth`。

- 验证步骤：
  1. 启动开发环境：`pnpm web dev`
  2. 默认为“手机模式”（窄 375px）。
  3. 点击右上角“手机/电脑”按钮或通过“视图 -> 预览模式”切换到“电脑端”，中间预览呈现中栏效果（最大 740px，居中）。
  4. 刷新页面后仍保留上次选择的预览模式（本地持久化）。

- 影响范围：
  - 仅影响预览区域宽度表现；移动端不变。
  - 与复制/渲染逻辑无耦合；复制到公众号功能不受影响。

- 回退与调整：
  - 回退为旧行为：把 `packages/shared/src/configs/style.ts:115` 改回 `w-full`。
  - 调整中栏宽度：修改同一行的 `max-w[...]` 数值即可。

## 导出功能优化（顶部按钮与留白修复）

- 目标：
  - 顶部右上角新增“导出PDF”、“导出PNG”、“导出长图”三个按钮，置于“复制”和“发布”之间。
  - 修复导出 PDF 的分页截断问题，并设置统一页边距。
  - 修复导出 PNG/长图的左右留白不明显、边缘灰线的问题；区分普通 PNG 与长图的取图范围。

- 关键改动：
  - 顶部按钮与交互：
    - `apps/web/src/components/editor/editor-header/index.vue:311-335`
      - 新增三个按钮：`导出PDF`、`导出PNG`、`导出长图`，分别调用导出函数。
    - `apps/web/src/components/editor/editor-header/index.vue:246-249`
      - 预览模式切换函数 `togglePreviewMode()`，与顶部“手机/电脑”按钮配合。
    - `apps/web/src/components/editor/editor-header/index.vue:3`
      - 修复图标导入语法，使用 `import { ... } from 'lucide-vue-next'`。

  - 导出 PNG/长图（留白与灰线修复、长图逻辑区分）：
    - 入口函数：`apps/web/src/stores/export.ts:49`
    - 选择导出元素：`.preview`，并同时选择内容容器 `#output`：`apps/web/src/stores/export.ts:55-58`
    - 留白基准（毫米转像素）：`apps/web/src/stores/export.ts:60`（默认 `const padPx = mm2px(20)`）
    - 清除边框与阴影，避免右侧灰线：`apps/web/src/stores/export.ts:71-81`
    - 应用留白：
      - `.preview` 左右留白：`apps/web/src/stores/export.ts:82-85`
      - `#output` 四周留白（左右为 `padPx`，上下为约 `0.6 * padPx`）：`apps/web/src/stores/export.ts:88-95`
    - PNG 与长图区分：
      - 长图：使用内容滚动尺寸 `scrollWidth/scrollHeight`，并在超大尺寸时降低像素比：`apps/web/src/stores/export.ts:86-92`
      - 普通 PNG：只截取当前可视区域高度，并隐藏溢出：`apps/web/src/stores/export.ts:93-100`
    - 样式恢复，避免污染编辑界面：`apps/web/src/stores/export.ts:107-109`

  - 导出 PDF（分页与边距）：
    - 导出函数：`apps/web/src/utils/index.ts:120-170`
    - 页边距：`@page { size: A4; margin: 10mm; }`：`apps/web/src/utils/index.ts:141`
    - 关键分页优化，避免代码块等被截断：
      - `pre, .code__pre, blockquote, figure, table, .preview-table, .md-blockquote, .mermaid { break-inside: avoid; page-break-inside: avoid; }`：`apps/web/src/utils/index.ts:145`
      - `thead { display: table-header-group; }`：`apps/web/src/utils/index.ts:146`
      - `h1–h6 { break-after: avoid; page-break-after: avoid; }`：`apps/web/src/utils/index.ts:148`

- 验证步骤：
  1. 构建：`pnpm -F web run build:only`
  2. 顶部点击“导出PDF”，预览中页边距为 10mm，代码块不会跨页截断。
  3. 顶部点击“导出PNG”，仅导出当前可视区域，左右留白显著；无灰色竖线。
  4. 顶部点击“导出长图”，导出全文长图，左右留白与普通 PNG 一致；超长内容自动调整像素比。

- 参数调整：
  - PNG/长图左右留白：修改 `apps/web/src/stores/export.ts:60` 的毫米值，例如：
    - `mm2px(15)` → 约 15mm
    - `mm2px(10)` → 约 10mm
  - PNG/长图上下留白比例：调整 `apps/web/src/stores/export.ts:92` 上下留白的系数（默认约 `0.6 * padPx`）。
  - PDF 页边距：修改 `apps/web/src/utils/index.ts:141` 的 `@page { margin: ... }` 值，如 `10mm/15mm`。

- 影响范围：
  - 仅影响导出行为与顶部按钮 UI；编辑与预览渲染不受影响。
  - 样式清理仅在导出过程中临时生效，导出后会恢复原样式。

- 回退与调整：
  - 若需要最小留白，可将 `apps/web/src/stores/export.ts:60` 改为 `mm2px(10)` 并把 `apps/web/src/stores/export.ts:92` 的上下系数调小。
  - 若需要更大 PDF 页边距，修改 `apps/web/src/utils/index.ts:141` 为 `margin: 15mm`。
