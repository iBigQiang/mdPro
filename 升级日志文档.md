# 升级日志文档

日期：2025-12-23

## 2025-12-23 12:25 (v1.1.5) 导出菜单功能统合（最终修复）

- 目标：确保 `FileDropdown.vue` 中的移动端（asSub）代码逻辑同步。
- 关键改动：
  - `FileDropdown.vue`: 彻底删除移动端冗余导出项，对齐顶部“导出”按钮。

## 2025-12-23 12:35 (v1.1.6) 导出菜单功能恢复与统合

- 目标：恢复被意外删除的导出选项，同时保持文案统一。
- 关键改动：
  - `FileDropdown.vue`: 恢复了 “Markdown文件”、“HTML文件” 和 “HTML（无样式）” 导出选项。
  - `FileDropdown.vue`: 统一了“导出PDF”和“导出图片”的文案与调用逻辑。

## 2025-12-23 12:10 (v1.1.2) 导出菜单功能统合

- 目标：将顶部菜单栏“文件-导出”的功能与右上角快捷导出按钮保持完全一致。
- 关键改动：
  - `FileDropdown.vue`: 删除了冗余的 Markdown 及 HTML 导出项。
  - `FileDropdown.vue`: 统一了“导出PDF”和“导出图片”的文案与调用逻辑。

## 2025-12-23 12:20 (v1.1.4) 导出菜单功能统合（再次修复）

- 目标：确保 `FileDropdown.vue` 中的代码逻辑真正同步。
- 关键改动：
  - `FileDropdown.vue`: 彻底删除冗余导出项，对齐顶部“导出”按钮。
  - `FileDropdown.vue`: 统一了“导出PDF”和“导出图片”的文案与调用逻辑。

## 2025-12-23 11:19 (v1.1.1) 本地开发文档完善

- 目标：提供清晰的本地开发与环境搭建指南。
- 关键改动：
  - `README.md`: 新增“本地开发与开发运行”章节，包含依赖安装与启动命令。
  - `README.md`: 补充了关于本地开发环境 `/md/` 子路径设计逻辑的说明。

## 2025-12-23 11:13 (v1.1.0) Docker 部署文档深度优化

- 目标：完善 Docker 部署指南，提供从源码构建到容器部署的全流程教程。
- 关键改动：
  - `README.md`: 细化了“自行构建镜像”章节。
  - `README.md`: 新增了 Git 克隆、目录切换、镜像构建与容器启动的标准操作指南。
  - `README.md`: 规范了镜像命名建议。

## 2025-12-23 11:06 (v1.0.9) Docker 构建稳定性修复

- 目标：解决 GitHub Actions 上的 Docker 构建失败问题（Error 254）。
- 关键改动：
  - `Dockerfile`: 从 `alpine` 切换到 `slim` (Debian) 基础镜像，以提供更好的二进制兼容性。
  - `Dockerfile`: 改为先复制完整代码再安装依赖，确保 `patches/` 补丁目录和所有工作区成员的属性被正确识别。
  - `.dockerignore` (新增): 排除 `node_modules` 和构建产物，优化构建上下文体积。

## 2025-12-23 11:03 (v1.0.8) README 文档深度同步

- 目标：确保所有文档链接、徽标和部署说明均指向当前的最新仓库和镜像地址。
- 关键改动：
  - `README.md`: 更新了顶部的状态徽标（Badges）、项目描述链接、Discussions 链接以及讨论区链接。
  - `README.md`: 移除了指向旧仓库 `doocs/md` 的 npm cli 和 Docker 说明，统一整合为基于 `iBigQiang/mdPro` 的 Docker 流。

## 2025-12-23 10:58 (v1.0.7) Docker Compose 部署支持

- 目标：提供更简单的容器编排部署方式。
- 关键改动：
  - `docker-compose.yml` (新增): 提供了标准的 Compose 配置文件，支持一键启动。
  - `README.md`: 补充了 Docker Compose 的详细说明和代码示例。

## 2025-12-23 10:55 (v1.0.6) Docker 容器化支持与自动化构建

- 目标：提供标准的 Docker 镜像并自动化 GHCR 发布流程。
- 关键改动：
  - `Dockerfile` (根目录): 新增多阶段构建配置，使用 pnpm 编译并行化处理依赖，最终镜像基于 nginx:alpine。
  - `.github/workflows/docker-push.yml`: 新增 CI 流程，在 push 到 main 或打标签时自动构建并推送镜像至 `ghcr.io/ibigqiang/mdpro`。
  - `scripts/release-pro.mjs`: 增加了 Docker 镜像更新提示。
  - `README.md`: 补充了详细的 Docker 拉取与运行指南。

## 2025-12-23 10:45 (v1.0.5) 发布自动化逻辑修复

- 目标：修复 GitHub Release 内容提取错误，确保只显示最新的增量更新。
- 关键改动：
  - `.github/workflows/release.yml`: 修改了日志提取逻辑，改用 Python 正则精准抓取第一个（最新的）`##` 块，不再错误提取历史记录。
  - `scripts/release-pro.mjs`: 增加了对本地 `gh` CLI 的检查，如果本地未安装，将引导用户依靠 GitHub Actions 自动处理发布，避免本地脚本报错。

## 2025-12-23 10:42 (v1.0.4) 自动化发布系统集成

- 目标：简化发布流程，自动提取增量更新日志并同步至 GitHub Releases。
- 关键改动：
  - `scripts/release-pro.mjs` (新增): 实现了自动提取最新日志、Git 提交、标签管理及 GitHub Release 自动创建。
  - `package.json`: 新增 `pnpm release` 快捷指令。
  - `README.md`: 补充了自动化发布流程的说明文档。

## 2025-12-23 10:27 (v1.0.3) 首页 HTML 标题更新

- 目标：将首页 `<title>` 标签更新为品牌化的标题。
- 关键改动：
  - `apps/web/index.html`
    - 修改 `<title>` 为 `mdPro 微信 Markdown 编辑器 | @iBigQiang`。

## 2025-12-23 10:14 (v1.0.2) 导出图片底部多余留白修复与文件名优化

- 目标：解决全屏预览模式下，导出图片底部出现大量冗余留白的问题。

- 关键改动：
  - `apps/web/src/stores/export.ts`
    - 在导出图片克隆预览元素时，强制设置 `min-height: 0 !important` 和 `height: auto !important`。
    - **优化文件名**：移除了导出的长图文件名中多余的 `.long` 标识，统一使用 `${标题}.png`。
    - 说明：由于全局样式中 `.preview` 存在 `min-height: 100%`，在全屏模式下会强制容器高度至少为视口高度。克隆时重置此属性后，容器高度将根据内容实际大小自适应收缩。
    - 兼容性：对于超长内容，容器仍会由于内容撑开而保持完整高度，测量逻辑 `scrollHeight` 依然能捕捉到全部内容。

- 验证步骤：
  1. 切换到“全屏”预览模式。
  2. 输入少量文字或简单表格。
  3. 点击“导出 -> 导出图片”。
  4. 检查生成的 PNG 文件，确认底部紧贴内容，无多余留白。
  5. 输入大量长内容，确认图片依然能完整显示全部内容。

- 影响范围：
  - 仅影响图片导出的视觉表现。
  - 优化了全屏模式下的出图效果，不影响手机/电脑模式的导出逻辑。

## 2025-12-23 09:45 全屏预览导出优化与交互改进

- 目标：
  - 彻底解决全屏预览模式下宽表格导出被截断的问题。
  - 实现“手机/电脑/全屏”三种预览模式下导出图片的宽度精准匹配。
  - 优化自定义 CSS 编辑器交互，支持手动拖动调整宽度。
  - 简化导出菜单，修复 PDF 导出的样式兼容性。

- 关键改动：
  - 图片导出核心逻辑重构 (Off-screen Cloning)：
    - `apps/web/src/stores/export.ts:51-220`
    - 策略：不再直接捕获当前 DOM，而是深度克隆预览元素到离屏容器，并强制移除所有宽度限制（`max-width: none`）。
    - 模式对齐：
      - **全屏模式**：表格完全展开（`white-space: nowrap`），适合导出超宽数据表。
      - **手机/电脑模式**：导出宽度锁定为 375px/740px，表格自动换行（`word-break: break-word`），确保与预览一致且无右侧留白。
    - 留白优化：手机/电脑模式下精准计算 padding，确保左右边距对称。
    - 图片适配：修复手机模式下文中大图显示不全的问题，强制 `max-width: 100%` 并居中。

  - 自定义 CSS 拖动分割线：
    - `apps/web/src/views/CodemirrorEditor.vue:725-783`
    - 实现：使用嵌套的 `ResizablePanelGroup` 将预览区与 CssEditor 包裹。
    - 交互：新增 `ResizableHandle` 分割线，支持在桌面端手动拖动调整 CSS 编辑框的宽度。
    - 逻辑：仅在 `isShowCssEditor` 为真时显示分割线，且自动处理右侧样式面板 `RightSlider` 的层级叠放。

  - 导出菜单简化：
    - `apps/web/src/components/editor/editor-header/index.vue:336-348`
    - 移除“导出PNG”（首屏截图），一般使用率极低且容易产生混淆。
    - 将“导出长图”更名为“导出图片”，作为主要的图文导出入口。

  - PDF 导出样式修复：
    - `packages/shared/src/configs/theme-css/WXGreen.css` 与 `apps/web/src/utils/index.ts`
    - 修复“微信绿”主题下 `h2` 标题在 PDF 导出时顶部出现多余边框线的问题。
    - 打印适配：在 `@media print` 中将 `h2` 的渐变背景替换为稳固的 `border-bottom`，确保不同 PDF 驱动下的渲染稳定性。

- 验证步骤：
  1. 切换到“全屏”预览，插入宽表格，点击“导出图片”，确认表格列显示完整，无横向滚动条。
  2. 切换到“手机”预览，点击“导出图片”，确认背景宽度为 375px，且左右边距一致，图片不被切除。
  3. 打开“样式 -> 自定义CSS”，鼠标放在预览区右侧边缘，确认可以左右拖动改变 CSS 编辑器宽度。
  4. 点击右上角“导出 -> 导出PDF”，确认标题样式正常，无顶部多余线条。

- 参数调整：
  - 导出边距：修改 `apps/web/src/stores/export.ts` 中的 `padPx`。
  - 默认拖动比例：修改 `apps/web/src/views/CodemirrorEditor.vue` 中 `ResizablePanel` 的 `default-size`。

- 影响范围：
  - 增强了复杂表格和大尺寸内容的导出质量。
  - 改善了开发者调整样式的体验。
  - 仅涉及导出与编辑器布局层级，不影响核心渲染逻辑。

## 2025-12-23 09:15 导出功能优化（顶部按钮与留白修复）

- 目标：
  - 顶部右上角新增“导出PDF”、“导出PNG”、“导出长图”三个按钮，置于“复制”和“发布”之间。
  - 修复导出 PDF 的分页截断问题，并设置统一页边距。
  - 修复导出 PNG/长图的左右留白不明显、边缘灰线的问题；区分普通 PNG 与长图的取图范围。

- 关键改动：
  - 顶部按钮与交互：
    - `apps/web/src/components/editor/editor-header/index.vue:311-335`
      - 新增三个按钮：`导出PDF`、`导出PNG`、`导出长图`，分别调用导出函数。
    - `apps/web/src/components/editor/editor-header/index.vue:246-249`
      - 预览模式切换函数 `togglePreviewMode()`，与顶部“手机/电脑”按钮配合。
    - `apps/web/src/components/editor/editor-header/index.vue:3`
      - 修复图标导入语法，使用 `import { ... } from 'lucide-vue-next'`。

  - 导出 PNG/长图（留白与灰线修复、长图逻辑区分）：
    - 入口函数：`apps/web/src/stores/export.ts:49`
    - 选择导出元素：`.preview`，并同时选择内容容器 `#output`：`apps/web/src/stores/export.ts:55-58`
    - 留白基准（毫米转像素）：`apps/web/src/stores/export.ts:60`（默认 `const padPx = mm2px(20)`）
    - 清除边框与阴影，避免右侧灰线：`apps/web/src/stores/export.ts:71-81`
    - 应用留白：
      - `.preview` 左右留白：`apps/web/src/stores/export.ts:82-85`
      - `#output` 四周留白（左右为 `padPx`，上下为约 `0.6 * padPx`）：`apps/web/src/stores/export.ts:88-95`
    - PNG 与长图区分：
      - 长图：使用内容滚动尺寸 `scrollWidth/scrollHeight`，并在超大尺寸时降低像素比：`apps/web/src/stores/export.ts:86-92`
      - 普通 PNG：只截取当前可视区域高度，并隐藏溢出：`apps/web/src/stores/export.ts:93-100`
    - 样式恢复，避免污染编辑界面：`apps/web/src/stores/export.ts:107-109`

  - 导出 PDF（分页与边距）：
    - 导出函数：`apps/web/src/utils/index.ts:120-170`
    - 页边距：`@page { size: A4; margin: 10mm; }`：`apps/web/src/utils/index.ts:141`
    - 关键分页优化，避免代码块等被截断：
      - `pre, .code__pre, blockquote, figure, table, .preview-table, .md-blockquote, .mermaid { break-inside: avoid; page-break-inside: avoid; }`：`apps/web/src/utils/index.ts:145`
      - `thead { display: table-header-group; }`：`apps/web/src/utils/index.ts:146`
      - `h1–h6 { break-after: avoid; page-break-after: avoid; }`：`apps/web/src/utils/index.ts:148`

- 验证步骤：
  1. 构建：`pnpm -F web run build:only`
  2. 顶部点击“导出PDF”，预览中页边距为 10mm，代码块不会跨页截断。
  3. 顶部点击“导出PNG”，仅导出当前可视区域，左右留白显著；无灰色竖线。
  4. 顶部点击“导出长图”，导出全文长图，左右留白与普通 PNG 一致；超长内容自动调整像素比。

- 参数调整：
  - PNG/长图左右留白：修改 `apps/web/src/stores/export.ts:60` 的毫米值，例如：
    - `mm2px(15)` → 约 15mm
    - `mm2px(10)` → 约 10mm
  - PNG/长图上下留白比例：调整 `apps/web/src/stores/export.ts:92` 上下留白的系数（默认约 `0.6 * padPx`）。
  - PDF 页边距：修改 `apps/web/src/utils/index.ts:141` 的 `@page { margin: ... }` 值，如 `10mm/15mm`。

- 影响范围：
  - 仅影响导出行为与顶部按钮 UI；编辑与预览渲染不受影响。
  - 样式清理仅在导出过程中临时生效，导出后会恢复原样式。

- 回退与调整：
  - 若需要最小留白，可将 `apps/web/src/stores/export.ts:60` 改为 `mm2px(10)` 并把 `apps/web/src/stores/export.ts:92` 的上下系数调小。
  - 若需要更大 PDF 页边距，修改 `apps/web/src/utils/index.ts:141` 为 `margin: 15mm`。

## 2025-12-23 09:00 PC 预览宽度优化与快捷切换按钮

- 目标：为中间预览区域提供接近公众号桌面浏览器的中栏宽度，并新增“手机/电脑”一键切换按钮。

- 关键改动：
  - packages/shared/src/configs/style.ts:115
    - 电脑端宽度由 `w-full` 调整为 `w-full max-w-[740px]`。
    - 说明：`max-w-[740px]` 限制最大宽度为 740px，同时在小屏下保持自适应填满。
    - 调整方式：如需改为 720/760/780px，只需把该处的数值改为 `max-w-[720px]`/`max-w-[760px]`/`max-w-[780px]`。

  - apps/web/src/components/editor/editor-header/index.vue
    - 引入图标与配置：顶部导入 `Monitor`、`Smartphone` 以及 `widthOptions`。
      - 位置：文件开头的 import（约第 2 行处）。
    - 状态与选项：通过 `storeToRefs(themeStore)` 读取 `previewWidth`，并定义 `mobileWidth = widthOptions[0].value`、`desktopWidth = widthOptions[1].value`。
      - 位置：脚本顶部状态区域（约第 30–40 行处）。
    - 切换函数：新增 `togglePreviewMode()`，在手机与电脑宽度之间切换，并调用 `editorRefresh()` 立即生效。
      - 位置：函数定义（约第 240 行附近）。
    - 顶部右侧按钮：在“复制”按钮左侧新增“手机/电脑”按钮，图标随当前模式变化。
      - 位置：template 右侧操作区（约第 283 行处）。

  - apps/web/src/views/CodemirrorEditor.vue:735
    - 预览容器类名绑定：非移动端直接应用 `themeStore.previewWidth`，配合 `mx-auto` 居中显示。
    - 说明：移动端仍强制 `w-full`，桌面端将受 `max-w-[740px]` 限制并居中显示。

  - apps/web/src/components/editor/editor-header/ViewDropdown.vue:70–83, 165–178
    - 视图菜单的“预览模式”子项：与 `widthOptions` 同源，和顶部按钮共用同一状态 `previewWidth`。

- 验证步骤：
  1. 启动开发环境：`pnpm web dev`
  2. 默认为“手机模式”（窄 375px）。
  3. 点击右上角“手机/电脑”按钮或通过“视图 -> 预览模式”切换到“电脑端”，中间预览呈现中栏效果（最大 740px，居中）。
  4. 刷新页面后仍保留上次选择的预览模式（本地持久化）。

- 影响范围：
  - 仅影响预览区域宽度表现；移动端不变。
  - 与复制/渲染逻辑无耦合；复制到公众号功能不受影响。

- 回退与调整：
  - 回退为旧行为：把 `packages/shared/src/configs/style.ts:115` 改回 `w-full`。
  - 调整中栏宽度：修改同一行的 `max-w[...]` 数值即可。
